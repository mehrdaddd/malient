"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var prosemirror_state_1 = require("prosemirror-state");
var extension_1 = require("./nodeviews/extension");
var actions_1 = require("./actions");
var utils_1 = require("./utils");
exports.pluginKey = new prosemirror_state_1.PluginKey('extensionPlugin');
exports.default = function (dispatch, providerFactory, extensionHandlers) {
    return new prosemirror_state_1.Plugin({
        state: {
            init: function () { return ({ element: null }); },
            apply: function (tr, state, prevState, nextState) {
                var meta = tr.getMeta(exports.pluginKey);
                if (meta) {
                    var newState = tslib_1.__assign({}, state, meta);
                    dispatch(exports.pluginKey, newState);
                    return newState;
                }
                return state;
            },
        },
        view: function () {
            return {
                update: function (view) {
                    var state = view.state, dispatch = view.dispatch;
                    var element = exports.pluginKey.getState(state).element;
                    if (element &&
                        (!document.body.contains(element) || !utils_1.getExtensionNode(state))) {
                        actions_1.setExtensionElement(null)(state, dispatch);
                    }
                },
            };
        },
        key: exports.pluginKey,
        props: {
            nodeViews: {
                extension: extension_1.default(providerFactory, extensionHandlers),
                bodiedExtension: extension_1.default(providerFactory, extensionHandlers),
                inlineExtension: extension_1.default(providerFactory, extensionHandlers),
            },
        },
    });
};
//# sourceMappingURL=plugin.js.map