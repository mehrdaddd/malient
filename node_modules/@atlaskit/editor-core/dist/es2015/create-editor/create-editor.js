import { Schema } from 'prosemirror-model';
import { sanitizeNodes } from '@atlaskit/editor-common';
import { analyticsService } from '../analytics';
import ErrorReporter from '../utils/error-reporter';
import { name, version } from '../version';
export function sortByRank(a, b) {
    return a.rank - b.rank;
}
export function fixExcludes(marks) {
    var markKeys = Object.keys(marks);
    var markGroups = new Set(markKeys.map(function (mark) { return marks[mark].group; }));
    markKeys.map(function (markKey) {
        var mark = marks[markKey];
        if (mark.excludes) {
            mark.excludes = mark.excludes
                .split(' ')
                .filter(function (group) { return markGroups.has(group); })
                .join(' ');
        }
    });
    return marks;
}
export function processPluginsList(plugins, editorProps) {
    /**
     * First pass to collect pluginsOptions
     */
    var pluginsOptions = plugins.reduce(function (acc, plugin) {
        if (plugin.pluginsOptions) {
            Object.keys(plugin.pluginsOptions).forEach(function (pluginName) {
                if (!acc[pluginName]) {
                    acc[pluginName] = [];
                }
                acc[pluginName].push(plugin.pluginsOptions[pluginName]);
            });
        }
        return acc;
    }, {});
    /**
     * Process plugins
     */
    return plugins.reduce(function (acc, plugin) {
        if (plugin.pmPlugins) {
            (_a = acc.pmPlugins).push.apply(_a, plugin.pmPlugins(plugin.name ? pluginsOptions[plugin.name] : undefined));
        }
        if (plugin.nodes) {
            (_b = acc.nodes).push.apply(_b, plugin.nodes(editorProps));
        }
        if (plugin.marks) {
            (_c = acc.marks).push.apply(_c, plugin.marks(editorProps));
        }
        if (plugin.contentComponent) {
            acc.contentComponents.push(plugin.contentComponent);
        }
        if (plugin.primaryToolbarComponent) {
            acc.primaryToolbarComponents.push(plugin.primaryToolbarComponent);
        }
        if (plugin.secondaryToolbarComponent) {
            acc.secondaryToolbarComponents.push(plugin.secondaryToolbarComponent);
        }
        return acc;
        var _a, _b, _c;
    }, {
        nodes: [],
        marks: [],
        pmPlugins: [],
        contentComponents: [],
        primaryToolbarComponents: [],
        secondaryToolbarComponents: [],
    });
}
export function createSchema(editorConfig) {
    var marks = fixExcludes(editorConfig.marks.sort(sortByRank).reduce(function (acc, mark) {
        acc[mark.name] = mark.mark;
        return acc;
    }, {}));
    var nodes = sanitizeNodes(editorConfig.nodes.sort(sortByRank).reduce(function (acc, node) {
        acc[node.name] = node.node;
        return acc;
    }, {}), marks);
    return new Schema({ nodes: nodes, marks: marks });
}
export function createPMPlugins(editorConfig, schema, props, dispatch, eventDispatcher, providerFactory, errorReporter) {
    return editorConfig.pmPlugins
        .sort(sortByRank)
        .map(function (_a) {
        var plugin = _a.plugin;
        return plugin({
            schema: schema,
            props: props,
            dispatch: dispatch,
            providerFactory: providerFactory,
            errorReporter: errorReporter,
            eventDispatcher: eventDispatcher,
        });
    })
        .filter(function (plugin) { return !!plugin; });
}
export function createErrorReporter(errorReporterHandler) {
    var errorReporter = new ErrorReporter();
    if (errorReporterHandler) {
        errorReporter.handler = errorReporterHandler;
    }
    return errorReporter;
}
export function initAnalytics(analyticsHandler) {
    analyticsService.handler = analyticsHandler || (function () { });
    analyticsService.trackEvent('atlassian.editor.start', {
        name: name,
        version: version,
    });
}
//# sourceMappingURL=create-editor.js.map