import { Plugin, PluginKey } from 'prosemirror-state';
import { TableMap } from 'prosemirror-tables';
import { DecorationSet } from 'prosemirror-view';
import { findTable } from 'prosemirror-utils';
import { createNumberColumnDecorationSet } from '../utils';
export var pluginKey = new PluginKey('tableNumberColumnPlugin');
var plugin = new Plugin({
    state: {
        init: function () { return ({
            decorationSet: DecorationSet.empty,
        }); },
        apply: function (tr, state) { return state; },
    },
    key: pluginKey,
    props: {
        // disable number column cells from editing
        decorations: function (state) { return createNumberColumnDecorationSet(state); },
    },
    // adjust number column on each table modification
    appendTransaction: function (transactions, oldState, newState) {
        var table = findTable(newState.selection);
        if (table &&
            table.node.attrs.isNumberColumnEnabled &&
            transactions.some(function (transaction) { return transaction.docChanged; }) &&
            // ignore the transaction that enables number column (otherwise it goes into infinite loop)
            !transactions.some(function (transaction) { return transaction.getMeta(pluginKey); })) {
            var map = TableMap.get(table.node);
            var start = findTable(newState.selection).pos;
            var tr = newState.tr;
            var _a = newState.schema.nodes, tableHeader = _a.tableHeader, paragraph = _a.paragraph;
            var increment = table.node.child(0).child(0).type === tableHeader ? 0 : 1;
            var updated = false;
            for (var i = 0; i < table.node.childCount; i++) {
                var cell = table.node.child(i).child(0);
                var textContent = "" + (i + increment);
                if (cell.type === tableHeader) {
                    continue;
                }
                var from = tr.mapping.map(start + map.map[i * map.width]);
                tr.replaceWith(from + 1, from + cell.nodeSize, paragraph.create({}, newState.schema.text(textContent)));
                updated = true;
            }
            if (updated) {
                return tr;
            }
        }
    },
});
export default plugin;
//# sourceMappingURL=number-column-plugin.js.map