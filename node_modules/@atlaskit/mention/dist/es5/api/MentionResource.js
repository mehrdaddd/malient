"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var util_service_support_1 = require("@atlaskit/util-service-support");
var types_1 = require("../types");
var logger_1 = require("../util/logger");
var searchIndex_1 = require("../util/searchIndex");
var MAX_QUERY_ITEMS = 100;
var MAX_NOTIFIED_ITEMS = 20;
var emptySecurityProvider = function () {
    return {
        params: {},
        headers: {},
    };
};
var AbstractResource = /** @class */ (function () {
    function AbstractResource() {
        this.changeListeners = new Map();
        this.allResultsListeners = new Map();
        this.errListeners = new Map();
        this.infoListeners = new Map();
    }
    AbstractResource.prototype.subscribe = function (key, callback, errCallback, infoCallback, allResultsCallback) {
        if (callback) {
            this.changeListeners.set(key, callback);
        }
        if (errCallback) {
            this.errListeners.set(key, errCallback);
        }
        if (infoCallback) {
            this.infoListeners.set(key, infoCallback);
        }
        if (allResultsCallback) {
            this.allResultsListeners.set(key, allResultsCallback);
        }
    };
    AbstractResource.prototype.unsubscribe = function (key) {
        this.changeListeners.delete(key);
        this.errListeners.delete(key);
        this.infoListeners.delete(key);
        this.allResultsListeners.delete(key);
    };
    return AbstractResource;
}());
exports.AbstractResource = AbstractResource;
var AbstractMentionResource = /** @class */ (function (_super) {
    tslib_1.__extends(AbstractMentionResource, _super);
    function AbstractMentionResource() {
        return _super !== null && _super.apply(this, arguments) || this;
    }
    AbstractMentionResource.prototype.shouldHighlightMention = function (mention) {
        return false;
    };
    // eslint-disable-next-line class-methods-use-this
    AbstractMentionResource.prototype.filter = function (query) {
        throw new Error("not yet implemented.\nParams: query=" + query);
    };
    // eslint-disable-next-line class-methods-use-this, no-unused-vars
    AbstractMentionResource.prototype.recordMentionSelection = function (mention) {
        // Do nothing
    };
    AbstractMentionResource.prototype.isFiltering = function (query) {
        return false;
    };
    AbstractMentionResource.prototype._notifyListeners = function (mentionsResult) {
        logger_1.default('ak-mention-resource._notifyListeners', mentionsResult &&
            mentionsResult.mentions &&
            mentionsResult.mentions.length, this.changeListeners);
        this.changeListeners.forEach(function (listener, key) {
            try {
                listener(mentionsResult.mentions.slice(0, MAX_NOTIFIED_ITEMS), mentionsResult.query);
            }
            catch (e) {
                // ignore error from listener
                logger_1.default("error from listener '" + key + "', ignoring", e);
            }
        });
    };
    AbstractMentionResource.prototype._notifyAllResultsListeners = function (mentionsResult) {
        logger_1.default('ak-mention-resource._notifyAllResultsListeners', mentionsResult &&
            mentionsResult.mentions &&
            mentionsResult.mentions.length, this.changeListeners);
        this.allResultsListeners.forEach(function (listener, key) {
            try {
                listener(mentionsResult.mentions.slice(0, MAX_NOTIFIED_ITEMS), mentionsResult.query);
            }
            catch (e) {
                // ignore error from listener
                logger_1.default("error from listener '" + key + "', ignoring", e);
            }
        });
    };
    AbstractMentionResource.prototype._notifyErrorListeners = function (error, query) {
        this.errListeners.forEach(function (listener, key) {
            try {
                listener(error, query);
            }
            catch (e) {
                // ignore error from listener
                logger_1.default("error from listener '" + key + "', ignoring", e);
            }
        });
    };
    AbstractMentionResource.prototype._notifyInfoListeners = function (info) {
        this.infoListeners.forEach(function (listener, key) {
            try {
                listener(info);
            }
            catch (e) {
                // ignore error fromr listener
                logger_1.default("error from listener '" + key + "', ignoring", e);
            }
        });
    };
    return AbstractMentionResource;
}(AbstractResource));
exports.AbstractMentionResource = AbstractMentionResource;
/**
 * Provides a Javascript API
 */
var MentionResource = /** @class */ (function (_super) {
    tslib_1.__extends(MentionResource, _super);
    function MentionResource(config) {
        var _this = _super.call(this) || this;
        if (!config.url) {
            throw new Error('config.url is a required parameter');
        }
        if (!config.securityProvider) {
            config['securityProvider'] = emptySecurityProvider;
        }
        _this.config = config;
        _this.lastReturnedSearch = 0;
        _this.searchIndex = new searchIndex_1.SearchIndex();
        _this.activeSearches = new Set();
        return _this;
    }
    MentionResource.prototype.shouldHighlightMention = function (mention) {
        if (this.config.shouldHighlightMention) {
            return this.config.shouldHighlightMention(mention);
        }
        return false;
    };
    MentionResource.prototype.notify = function (searchTime, mentionResult, query) {
        var _this = this;
        this.sortMentionsResult(mentionResult).then(function (sortedMentionsResult) {
            if (searchTime > _this.lastReturnedSearch) {
                _this.lastReturnedSearch = searchTime;
                _this._notifyListeners(sortedMentionsResult);
            }
            else {
                var date = new Date(searchTime).toISOString().substr(17, 6);
                logger_1.default('Stale search result, skipping', date, query); // eslint-disable-line no-console, max-len
            }
            _this._notifyAllResultsListeners(sortedMentionsResult);
        });
    };
    MentionResource.prototype.notifyError = function (error, query) {
        this._notifyErrorListeners(error, query);
        if (query) {
            this.activeSearches.delete(query);
        }
    };
    MentionResource.prototype.filter = function (query) {
        var _this = this;
        var searchTime = Date.now();
        if (!query) {
            this.initialState().then(function (results) { return _this.notify(searchTime, results, query); }, function (error) { return _this.notifyError(error, query); });
        }
        else {
            this.activeSearches.add(query);
            this.search(query).then(function (results) { return _this.notify(searchTime, results, query); }, function (error) { return _this.notifyError(error, query); });
        }
    };
    MentionResource.prototype.recordMentionSelection = function (mention) {
        return this.recordSelection(mention).then(function () { }, function (error) { return logger_1.default("error recording mention selection: " + error, error); });
    };
    MentionResource.prototype.isFiltering = function (query) {
        return this.activeSearches.has(query);
    };
    MentionResource.prototype.initialState = function () {
        return this.remoteInitialState();
    };
    MentionResource.prototype.getUserIdsInContext = function () {
        if (this.config.getUsersInContext) {
            return this.config
                .getUsersInContext()
                .then(function (users) {
                return users.reduce(function (acc, value) { return acc.add(value.id); }, new Set());
            });
        }
        return Promise.resolve(new Set());
    };
    /**
     * Returns the initial mention display list before a search is performed for the specified
     * container.
     *
     * @param containerId
     * @returns Promise
     */
    MentionResource.prototype.remoteInitialState = function () {
        var _this = this;
        var queryParams = {};
        if (this.config.containerId) {
            queryParams['containerId'] = this.config.containerId;
        }
        if (this.config.productId) {
            queryParams['productIdentifier'] = this.config.productId;
        }
        var options = {
            path: 'bootstrap',
            queryParams: queryParams,
        };
        return util_service_support_1.utils
            .requestService(this.config, options)
            .then(function (result) { return _this.transformServiceResponse(result); })
            .then(function (result) {
            _this.searchIndex.indexResults(result.mentions);
            return result;
        });
    };
    MentionResource.prototype.search = function (query) {
        var _this = this;
        if (this.searchIndex.hasDocuments()) {
            return this.searchIndex.search(query).then(function (result) {
                var searchTime = Date.now() + 1; // Ensure that search time is different than the local search time
                _this.remoteSearch(query).then(function (result) {
                    _this.activeSearches.delete(query);
                    _this.notify(searchTime, result, query);
                    _this.searchIndex.indexResults(result.mentions);
                }, function (err) {
                    _this._notifyErrorListeners(err);
                });
                return result;
            });
        }
        return this.remoteSearch(query).then(function (result) {
            _this.searchIndex.indexResults(result.mentions);
            return result;
        });
    };
    MentionResource.prototype.sortMentionsResult = function (mentionsResult) {
        return this.getUserIdsInContext().then(function (userIdsInContext) {
            return tslib_1.__assign({}, mentionsResult, { mentions: mentionsResult.mentions.sort(searchIndex_1.mentionDescriptionComparator(userIdsInContext)) });
        });
    };
    MentionResource.prototype.remoteSearch = function (query) {
        var _this = this;
        var queryParams = {
            query: query,
            limit: MAX_QUERY_ITEMS,
        };
        if (this.config.containerId) {
            queryParams['containerId'] = this.config.containerId;
        }
        if (this.config.productId) {
            queryParams['productIdentifier'] = this.config.productId;
        }
        var options = {
            path: 'search',
            queryParams: queryParams,
        };
        return util_service_support_1.utils
            .requestService(this.config, options)
            .then(function (result) { return _this.transformServiceResponse(result); });
    };
    MentionResource.prototype.transformServiceResponse = function (result) {
        var mentions = result.mentions.map(function (mention, index) {
            var lozenge;
            var weight = mention.weight !== undefined ? mention.weight : index;
            if (types_1.isAppMention(mention)) {
                lozenge = mention.userType;
            }
            else if (types_1.isTeamMention(mention)) {
                lozenge = mention.userType;
            }
            return tslib_1.__assign({}, mention, { lozenge: lozenge, weight: weight });
        });
        return tslib_1.__assign({}, result, { mentions: mentions });
    };
    MentionResource.prototype.recordSelection = function (mention) {
        var queryParams = {
            selectedUserId: mention.id,
        };
        if (this.config.productId) {
            queryParams['productIdentifier'] = this.config.productId;
        }
        var options = {
            path: 'record',
            queryParams: queryParams,
            requestInit: {
                method: 'POST',
            },
        };
        return util_service_support_1.utils.requestService(this.config, options);
    };
    return MentionResource;
}(AbstractMentionResource));
var HttpError = /** @class */ (function () {
    function HttpError(statusCode, statusMessage) {
        this.statusCode = statusCode;
        this.message = statusMessage;
        this.name = 'HttpError';
        this.stack = new Error().stack;
    }
    return HttpError;
}());
exports.HttpError = HttpError;
exports.default = MentionResource;
//# sourceMappingURL=MentionResource.js.map