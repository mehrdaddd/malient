"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var actions_1 = require("../actions");
var changeAccount_1 = require("../actions/changeAccount");
exports.startCloudAccountOAuthFlow = function (fetcher, cloudService) { return function (store) { return function (next) { return function (action) {
    if (action.type === actions_1.START_AUTH) {
        var _a = store.getState(), apiUrl_1 = _a.apiUrl, redirectUrl = _a.redirectUrl, userAuthProvider_1 = _a.userAuthProvider;
        var serviceName_1 = action.serviceName;
        cloudService
            .startAuth(apiUrl_1, redirectUrl, serviceName_1)
            .then(function () { return userAuthProvider_1(); })
            .then(function (auth) { return fetcher.getServiceList(apiUrl_1, auth); })
            .then(function (accounts) {
            store.dispatch(actions_1.updateServiceList(accounts));
            var selectedAccount = accounts.find(function (account) { return account.type === serviceName_1; });
            if (selectedAccount) {
                store.dispatch(changeAccount_1.changeAccount(serviceName_1, selectedAccount.id));
            }
        })
            .catch(function (error) {
            // https://jira.atlassian.com/browse/FIL-3247
            // add error handler
        });
    }
    return next(action);
}; }; }; };
//# sourceMappingURL=startAuth.js.map