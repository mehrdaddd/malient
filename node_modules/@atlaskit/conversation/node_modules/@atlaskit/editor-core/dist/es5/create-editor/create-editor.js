"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var prosemirror_model_1 = require("prosemirror-model");
var editor_common_1 = require("@atlaskit/editor-common");
var analytics_1 = require("../analytics");
var error_reporter_1 = require("../utils/error-reporter");
var version_1 = require("../version");
function sortByRank(a, b) {
    return a.rank - b.rank;
}
exports.sortByRank = sortByRank;
function fixExcludes(marks) {
    var markKeys = Object.keys(marks);
    var markGroups = new Set(markKeys.map(function (mark) { return marks[mark].group; }));
    markKeys.map(function (markKey) {
        var mark = marks[markKey];
        if (mark.excludes) {
            mark.excludes = mark.excludes
                .split(' ')
                .filter(function (group) { return markGroups.has(group); })
                .join(' ');
        }
    });
    return marks;
}
exports.fixExcludes = fixExcludes;
function processPluginsList(plugins, editorProps) {
    /**
     * First pass to collect pluginsOptions
     */
    var pluginsOptions = plugins.reduce(function (acc, plugin) {
        if (plugin.pluginsOptions) {
            Object.keys(plugin.pluginsOptions).forEach(function (pluginName) {
                if (!acc[pluginName]) {
                    acc[pluginName] = [];
                }
                acc[pluginName].push(plugin.pluginsOptions[pluginName]);
            });
        }
        return acc;
    }, {});
    /**
     * Process plugins
     */
    return plugins.reduce(function (acc, plugin) {
        if (plugin.pmPlugins) {
            (_a = acc.pmPlugins).push.apply(_a, plugin.pmPlugins(plugin.name ? pluginsOptions[plugin.name] : undefined));
        }
        if (plugin.nodes) {
            (_b = acc.nodes).push.apply(_b, plugin.nodes(editorProps));
        }
        if (plugin.marks) {
            (_c = acc.marks).push.apply(_c, plugin.marks(editorProps));
        }
        if (plugin.contentComponent) {
            acc.contentComponents.push(plugin.contentComponent);
        }
        if (plugin.primaryToolbarComponent) {
            acc.primaryToolbarComponents.push(plugin.primaryToolbarComponent);
        }
        if (plugin.secondaryToolbarComponent) {
            acc.secondaryToolbarComponents.push(plugin.secondaryToolbarComponent);
        }
        return acc;
        var _a, _b, _c;
    }, {
        nodes: [],
        marks: [],
        pmPlugins: [],
        contentComponents: [],
        primaryToolbarComponents: [],
        secondaryToolbarComponents: [],
    });
}
exports.processPluginsList = processPluginsList;
function createSchema(editorConfig) {
    var marks = fixExcludes(editorConfig.marks.sort(sortByRank).reduce(function (acc, mark) {
        acc[mark.name] = mark.mark;
        return acc;
    }, {}));
    var nodes = editor_common_1.sanitizeNodes(editorConfig.nodes.sort(sortByRank).reduce(function (acc, node) {
        acc[node.name] = node.node;
        return acc;
    }, {}), marks);
    return new prosemirror_model_1.Schema({ nodes: nodes, marks: marks });
}
exports.createSchema = createSchema;
function createPMPlugins(editorConfig, schema, props, dispatch, eventDispatcher, providerFactory, errorReporter) {
    return editorConfig.pmPlugins
        .sort(sortByRank)
        .map(function (_a) {
        var plugin = _a.plugin;
        return plugin({
            schema: schema,
            props: props,
            dispatch: dispatch,
            providerFactory: providerFactory,
            errorReporter: errorReporter,
            eventDispatcher: eventDispatcher,
        });
    })
        .filter(function (plugin) { return !!plugin; });
}
exports.createPMPlugins = createPMPlugins;
function createErrorReporter(errorReporterHandler) {
    var errorReporter = new error_reporter_1.default();
    if (errorReporterHandler) {
        errorReporter.handler = errorReporterHandler;
    }
    return errorReporter;
}
exports.createErrorReporter = createErrorReporter;
function initAnalytics(analyticsHandler) {
    analytics_1.analyticsService.handler = analyticsHandler || (function () { });
    analytics_1.analyticsService.trackEvent('atlassian.editor.start', {
        name: version_1.name,
        version: version_1.version,
    });
}
exports.initAnalytics = initAnalytics;
//# sourceMappingURL=create-editor.js.map