"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var tslib_1 = require("tslib");
var actions_1 = require("./actions");
var create_reducer_1 = require("./create-reducer");
var updateComment = function (comments, newComment) {
    return (comments || []).map(function (comment) {
        if ((newComment.localId && comment.localId === newComment.localId) ||
            comment.commentId === newComment.commentId) {
            return tslib_1.__assign({}, comment, { oldDocument: comment.oldDocument || comment.document }, newComment);
        }
        return comment;
    });
};
var removeComment = function (comments, commentToRemove) {
    return (comments || []).filter(function (comment) {
        return ((commentToRemove.localId &&
            comment.localId !== commentToRemove.localId) ||
            comment.commentId !== commentToRemove.commentId);
    });
};
var updateConversation = function (conversations, newConversation) {
    return conversations.map(function (conversation) {
        if (conversation.localId === newConversation.localId) {
            return newConversation;
        }
        return conversation;
    });
};
var updateCommentInConversation = function (conversations, newComment) {
    return conversations.map(function (conversation) {
        if (conversation.conversationId === newComment.conversationId) {
            var comments = updateComment(conversation.comments, newComment);
            return tslib_1.__assign({}, conversation, { comments: comments });
        }
        return conversation;
    });
};
var addOrUpdateCommentInConversation = function (conversations, newComment) {
    return conversations.map(function (conversation) {
        if (conversation.conversationId === newComment.conversationId) {
            var _a = conversation.comments, comments = _a === void 0 ? [] : _a;
            // If the comment already exists, update the existing one
            if (newComment.localId &&
                comments.some(function (comment) { return newComment.localId === comment.localId; })) {
                return tslib_1.__assign({}, conversation, { comments: updateComment(comments, newComment) });
            }
            // Otherwise, add it
            return tslib_1.__assign({}, conversation, { comments: comments.concat([newComment]) });
        }
        return conversation;
    });
};
var removeCommentFromConversation = function (conversations, commentToRemove) {
    return conversations.reduce(function (current, conversation) {
        if (conversation.conversationId === commentToRemove.conversationId) {
            var comments = removeComment(conversation.comments, commentToRemove);
            // If there's no comments, don't add the conversation
            if (comments.length === 0) {
                return current;
            }
            return current.concat([
                tslib_1.__assign({}, conversation, { comments: comments }),
            ]);
        }
        return current.concat([conversation]);
    }, []);
};
var getCommentFromConversation = function (conversations, commentToFind) {
    var commentId = commentToFind.commentId, conversationId = commentToFind.conversationId;
    if (!conversationId || !commentId) {
        return null;
    }
    var _a = conversations.reduce(function (acc, conversation) {
        if (conversation.conversationId !== conversationId ||
            !conversation.comments) {
            return acc;
        }
        return conversation.comments.reduce(function (commentsAcc, comment) {
            if (comment.commentId !== commentId) {
                return commentsAcc;
            }
            return commentsAcc.concat([comment]);
        }, acc);
    }, [])[0], comment = _a === void 0 ? null : _a;
    return comment;
};
exports.initialState = {
    conversations: [],
};
exports.reducers = create_reducer_1.createReducer(exports.initialState, (_a = {},
    _a[actions_1.FETCH_CONVERSATIONS_REQUEST] = function (state, action) {
        return tslib_1.__assign({}, state);
    },
    _a[actions_1.FETCH_CONVERSATIONS_SUCCESS] = function (state, action) {
        var conversations = state.conversations.concat(action.payload);
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.ADD_COMMENT_REQUEST] = function (state, action) {
        var payload = action.payload;
        var conversations = addOrUpdateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { isPlaceholder: true, state: 'SAVING' }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.ADD_COMMENT_SUCCESS] = function (state, action) {
        var payload = action.payload;
        var conversations;
        conversations = addOrUpdateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: undefined, oldDocument: undefined, isPlaceholder: false }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.ADD_COMMENT_ERROR] = function (state, action) {
        var payload = action.payload;
        var conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: 'ERROR' }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.UPDATE_COMMENT_REQUEST] = function (state, action) {
        var payload = action.payload;
        var conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: 'SAVING' }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.UPDATE_COMMENT_SUCCESS] = function (state, action) {
        var payload = action.payload;
        var conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: undefined, oldDocument: undefined }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.UPDATE_COMMENT_ERROR] = function (state, action) {
        var payload = action.payload;
        var conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: 'ERROR' }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.DELETE_COMMENT_REQUEST] = function (state, action) {
        var payload = action.payload;
        var conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: 'SAVING' }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.DELETE_COMMENT_SUCCESS] = function (state, action) {
        var payload = action.payload;
        var conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: undefined, deleted: true, oldDocument: undefined }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.DELETE_COMMENT_ERROR] = function (state, action) {
        var payload = action.payload;
        var conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: 'ERROR' }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.REVERT_COMMENT] = function (state, action) {
        var payload = action.payload;
        var comment = getCommentFromConversation(state.conversations, payload);
        var conversations;
        if (!comment) {
            return state;
        }
        if (comment.isPlaceholder) {
            conversations = removeCommentFromConversation(state.conversations, tslib_1.__assign({}, payload));
        }
        else {
            conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, payload, { state: undefined, document: comment.oldDocument, deleted: false, oldDocument: undefined }));
        }
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.HIGHLIGHT_COMMENT] = function (state, action) {
        var payload = action.payload;
        var highlighted = payload.commentId.toString();
        return tslib_1.__assign({}, state, { highlighted: highlighted });
    },
    _a[actions_1.UPDATE_USER_SUCCESS] = function (state, action) {
        return tslib_1.__assign({}, state, { user: action.payload.user });
    },
    _a[actions_1.CREATE_CONVERSATION_REQUEST] = function (state, action) {
        var payload = action.payload;
        var comment = payload.comments[0];
        var conversations = state.conversations.concat([
            tslib_1.__assign({}, payload, { comments: [
                    tslib_1.__assign({}, comment, { state: 'SAVING', isPlaceholder: true }),
                ] }),
        ]);
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.CREATE_CONVERSATION_SUCCESS] = function (state, action) {
        var payload = action.payload;
        var conversations = updateConversation(state.conversations, payload);
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a[actions_1.CREATE_CONVERSATION_ERROR] = function (state, action) {
        var _a = action.payload, comment = _a.comments[0], error = _a.error;
        var conversations = updateCommentInConversation(state.conversations, tslib_1.__assign({}, comment, { state: 'ERROR', error: error }));
        return tslib_1.__assign({}, state, { conversations: conversations });
    },
    _a));
var _a;
//# sourceMappingURL=reducers.js.map