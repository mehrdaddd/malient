"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var actions_1 = require("../actions");
exports.fetchNextCloudFilesPageMiddleware = function (fetcher) { return function (store) { return function (next) { return function (action) {
    if (actions_1.isFetchNextCloudFilesPageAction(action)) {
        var userAuthProvider = store.getState().userAuthProvider;
        var serviceName_1 = action.serviceName, accountId_1 = action.accountId, path_1 = action.path;
        var folderId_1 = (path_1[path_1.length - 1] || { id: '' }).id;
        var _a = store.getState(), apiUrl_1 = _a.apiUrl, view = _a.view;
        var cursor_1 = view && view.nextCursor;
        var items_1 = (view && view.items) || [];
        userAuthProvider()
            .then(function (auth) {
            return fetcher.fetchCloudAccountFolder(apiUrl_1, auth, serviceName_1, accountId_1, folderId_1, cursor_1);
        })
            .then(function (folder) {
            return store.dispatch(actions_1.fileListUpdate(accountId_1, path_1, items_1.concat(folder.items), cursor_1, folder.cursor));
        })
            .catch(function (error) {
            /* TODO: error collector */
            if (error.response && error.response.status === 401) {
                store.dispatch(actions_1.requestUnlinkCloudAccount({ id: accountId_1, name: serviceName_1 }));
            }
        });
    }
    return next(action);
}; }; }; };
//# sourceMappingURL=fetchNextCloudFilesPage.js.map